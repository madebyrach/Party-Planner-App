<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Party Menu Optimizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for smooth scrolling and clean font */
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .input-group label { transition: all 0.3s; }
        .input-group input:focus + label { color: #4f46e5; transform: translateY(-1.5rem) scale(0.9); }
        .input-group.has-content label { color: #4f46e5; transform: translateY(-1.5rem) scale(0.9); }
        .card { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700">AI Party Menu Optimizer</h1>
            <p class="text-gray-500 mt-2">Plan your perfect party: tell us what you're serving, and Gemini will calculate the precise quantities you need.</p>
        </header>

        <!-- Input Card -->
        <div class="card bg-white p-6 md:p-10 rounded-xl border border-gray-100 mb-10">
            <form id="optimizerForm">
                <div class="mb-6">
                    <label for="guests" class="block text-sm font-medium text-gray-700 mb-1">Number of Guests (Required)</label>
                    <input type="number" id="guests" required min="1" placeholder="e.g., 20" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <!-- Menu Item Inputs (Grouped for readability) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="appetizers" class="block text-sm font-medium text-gray-700 mb-1">Appetizers (e.g., Mini Quiches, Cheese Board)</label>
                        <textarea id="appetizers" rows="2" placeholder="List items or styles" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                    </div>
                    <div>
                        <label for="mainCourses" class="block text-sm font-medium text-gray-700 mb-1">Main Courses (e.g., Pulled Pork, Vegetarian Lasagna)</label>
                        <textarea id="mainCourses" rows="2" placeholder="List items" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                    </div>
                    <div>
                        <label for="sideDishes" class="block text-sm font-medium text-gray-700 mb-1">Side Dishes (e.g., Potato Salad, Green Beans)</label>
                        <textarea id="sideDishes" rows="2" placeholder="List items" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                    </div>
                    <div>
                        <label for="desserts" class="block text-sm font-medium text-gray-700 mb-1">Desserts (e.g., Cupcakes, Fruit Platter)</label>
                        <textarea id="desserts" rows="2" placeholder="List items" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                    </div>
                </div>

                <div class="mt-6">
                    <label for="otherItems" class="block text-sm font-medium text-gray-700 mb-1">Other Items (e.g., Beverages, Ice, Paper Plates)</label>
                    <textarea id="otherItems" rows="2" placeholder="List items" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                </div>

                <button type="submit" id="optimizeButton"
                        class="w-full mt-8 py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    <span id="buttonText">Calculate Optimized Quantities</span>
                    <div id="loadingSpinner" class="hidden spinner border-2 border-t-2 border-white border-opacity-20 rounded-full w-5 h-5 animate-spin mx-auto"></div>
                </button>
            </form>
        </div>

        <!-- Output Section -->
        <div id="outputSection" class="card bg-white p-6 md:p-10 rounded-xl border border-gray-100 hidden">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6">Optimized Plan:</h2>
            
            <div id="resultsTableContainer" class="overflow-x-auto">
                <!-- Table will be generated here -->
            </div>

            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg border border-red-300"></div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('optimizerForm');
            const outputSection = document.getElementById('outputSection');
            const resultsTableContainer = document.getElementById('resultsTableContainer');
            const errorMessageDiv = document.getElementById('errorMessage');
            const optimizeButton = document.getElementById('optimizeButton');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');

            // IMPORTANT: Since Vercel dev server may use a different port (e.g., 3001), 
            // we use the RELATIVE path /api/optimize. This way, the browser automatically 
            // uses the host and port Vercel provided (e.g., http://localhost:3001).
            const API_URL = '/api/optimize'; 

            /**
             * Handles the form submission, sends data to the server, and processes the JSON response.
             */
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Reset UI
                outputSection.classList.add('hidden');
                errorMessageDiv.classList.add('hidden');
                resultsTableContainer.innerHTML = '';
                
                // Show loading state
                buttonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                optimizeButton.disabled = true;

                // Gather form data
                const formData = {
                    guests: parseInt(document.getElementById('guests').value),
                    appetizers: document.getElementById('appetizers').value.trim(),
                    mainCourses: document.getElementById('mainCourses').value.trim(),
                    sideDishes: document.getElementById('sideDishes').value.trim(),
                    desserts: document.getElementById('desserts').value.trim(),
                    otherItems: document.getElementById('otherItems').value.trim(),
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                    });

                    // Server responded, but might be an error (e.g., 400, 500)
                    if (!response.ok) {
                        const errorData = await response.text(); 
                        throw new Error(`HTTP Error! Status: ${response.status}. Details: ${errorData}`);
                    }

                    // Server responded successfully (Status 200), parse the JSON
                    const data = await response.json(); 
                    
                    if (Array.isArray(data) && data.length > 0) {
                        renderResultsTable(data);
                        outputSection.classList.remove('hidden');
                    } else {
                        throw new Error("Received an empty or invalid plan from the server.");
                    }

                } catch (error) {
                    console.error("Fetch or Processing Error:", error);
                    errorMessageDiv.textContent = `CRITICAL ERROR: Failed to fetch data or process response. Details: ${error.message}`;
                    errorMessageDiv.classList.remove('hidden');
                    outputSection.classList.remove('hidden'); // Show the section to display the error
                } finally {
                    // Hide loading state
                    buttonText.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    optimizeButton.disabled = false;
                }
            });


            /**
             * Generates an HTML table from the JSON array of optimized items.
             * @param {Array<Object>} data - The array of plan objects.
             */
            function renderResultsTable(data) {
                // Group items by category for a cleaner, organized view
                const groupedData = data.reduce((acc, item) => {
                    const category = item.category || 'Uncategorized';
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(item);
                    return acc;
                }, {});

                let htmlContent = '';

                for (const category in groupedData) {
                    htmlContent += `
                        <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3 border-b-2 border-indigo-100 pb-1">${category}</h3>
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Item</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Quantity Needed</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                    `;

                    groupedData[category].forEach(item => {
                        htmlContent += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.item}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-bold">${item.quantity}</td>
                            </tr>
                        `;
                    });

                    htmlContent += `
                            </tbody>
                        </table>
                    `;
                }

                resultsTableContainer.innerHTML = htmlContent;
            }

            // Simple loading spinner definition for better visual feedback
            const style = document.createElement('style');
            style.textContent = `
                .spinner {
                    border-top-color: #4f46e5;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>